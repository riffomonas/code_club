---
layout: post
title: "Exploring the volatility of the S&P500 under Trump using the quantmod and tidyverse R packages (CC357)"
blurb: "That's a lot of volatility..."
author: "PD Schloss"
date: 2025-05-02 8:00
comments: false
youtube: -UpqE1ilVuo
start_hash: 
end_hash: 
---

Pat uses the quantmod and tidyverse packages to recreate a plot showing the changes in the S&P500 over the initial months of the Trump presidency. The plot generated functions from the tidyverse. To pull this off he uses the quantmod, dplyr, ggplot2, showtext, and ggtext packages. The functions he uses from these packages include aes, as.Date, as_tibble, coord_cartesian, drop_na, element_blank, element_markdown, element_text, filter, font_add_google, geom_hline, geom_line, geom_point, geom_rect, geom_text, getSymbols, ggplot, ggsave, isoweek, label_number, labs, lag, library, map_dbl, margin, max, min, month, mutate, nest, parse_date, pull, scale_fill_manual, scale_x_date, scale_y_continuous, select, seq, showtext_auto, showtext_opts, slice_max, summarize, theme, today, unique, unnest, and year. You can find the code he developed in this episode at https://www.riffomonas.org/code_club/2025-05-02-sandp500_weekly. The newsletter describing this visualization at a 30,000 ft view can be found at https://shop.riffomonas.org/posts/two-ways-to-plot-a-dumpster-fire. You can find the original article at https://www.nytimes.com/live/2025/04/04/business/trump-tariffs-stocks-economy?smid=url-share#investors-recoil-from-trumps-pledge-to-remake-the-global-economy. If you have a figure that you would like to see me discuss in a future newsletter and episode of Code Club, email me at pat@riffomonas.org!

<iframe style="margin: 0 auto;display:block;" width="560" height="315" src="https://www.youtube.com/embed/{{ page.youtube }}" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>


## Code

```R
library(tidyverse)
library(showtext)
library(ggtext)

font_add_google("Libre Franklin", "franklin")
showtext_opts(dpi = 300)
showtext_auto()

pre <- read_csv("Weekly_Counts_of_Deaths_by_Jurisdiction_and_Age_20250421.csv", 
         col_types = cols(`Week Ending Date` = col_date(format = "%m/%d/%Y"))) %>%
  filter(Jurisdiction == "United States" & Type == "Unweighted") %>%
  # filter(`Age Group` == "25-44 years", `Week Ending Date` == "2015-01-10") %>%
  # print(width = Inf)
  # count(`Age Group`, `Week Ending Date`)
  summarize(pre_deaths = sum(`Number of Deaths`), .by = `Week Ending Date`) %>%
  rename(date = `Week Ending Date`)
  
post <- read_csv("Provisional_COVID-19_Death_Counts_by_Week_Ending_Date_and_State_20250421.csv",
         col_types = cols(`End Date` = col_date(format = "%m/%d/%Y"))) %>%
  filter(State == "United States" & Group == "By Week") %>%
  select(date = `End Date`,
         post_deaths = `Total Deaths`)

deaths_by_week <- full_join(pre, post, by = "date") %>%
  mutate(deaths = if_else(is.na(post_deaths), pre_deaths, post_deaths)) %>%
  select(date, deaths) %>%
  mutate(pre_post = if_else(date < "2020-03-01", "pre", "post")) %>%
  filter(date >= "2015-03-01" & date <= "2025-03-01")

pre_deaths <- deaths_by_week %>%
  filter(pre_post == "pre") %>%
  summarize(mean = mean(deaths)) %>%
  pull(mean)

deaths_by_week %>%
  ggplot(aes(x = date, y = deaths, color = pre_post)) +
  geom_rect(xmin = ymd("2020-03-01"), xmax = ymd("2026-03-01"),
            ymin = 0, ymax = 1e6, fill = "#FCF0E9", color = "white") +
  geom_hline(yintercept = c(60000, 80000, pre_deaths),
             linewidth = c(0.2, 0.2, 0.4),
             color = c("gray80", "gray80", "black"),
             linetype = c(1, 1, 2)) +
  geom_line(show.legend = FALSE,
            linewidth = 0.75) +
  annotate(geom = "text", hjust = 0, vjust = -0.2,
           family = "franklin", size = 8.5, size.unit = "pt",
           x = ymd("2015-03-01"),
           y = c(60000, 80000),
           label = c("60,000", "80,000 deaths per week")) +
  annotate(geom = "text", family = "franklin",
           x = ymd("2022-09-01"),
           y = pre_deaths * 0.98,
           label = "2015-19 average") +
  coord_cartesian(expand = FALSE, clip = "off") +
  scale_y_continuous(breaks = c(60000, 80000),
                     limits = c(45000, 89000)) +
  scale_x_date(breaks = ymd(c("2016-01-01", "2018-01-01", "2020-03-01",
                              "2022-01-01", "2024-01-01")),
               labels = c("2016", "2018", "March 2020", "2022", "2024")) +
  scale_color_manual(breaks = c("pre", "post"),
                     values = c("#58595B", "#F05A27")) +
  labs(x = NULL,
       y = NULL,
       title = "Total U.S. deaths") +
  theme(
    text = element_text(family = "franklin"),
    plot.background = element_rect(fill = "#EEEEEE"),
    plot.title = element_textbox_simple(face = "bold", size = 11.5,
                                        fill = "white", width = NULL,
                                        padding = margin(5, 4, 5, 4),
                                        hjust = 0),
    plot.margin = margin(4, 15, 10, 10),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.text.x = element_text(size = 8.5, margin = margin(t = 3),
                               color = "black"),
    axis.ticks.length.x = unit(4, "pt"),
    axis.ticks.x = element_line(linewidth = 0.4),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_rect(fill = NA)
  )

ggsave("pre_post_covid.png", width = 6, height = 4.26)
```
